require 'socket'
require 'openssl'

usage = "\r\nUsage : ruby sslinfo.rb IP\r\n\r\n"
if ARGV.length < 1
  ip  = $stdin.read.chomp
else 
  ip = ARGV[0].chomp
end

regex_CN = /.*CN=(.*)$/
regex_alt  = /DNS:(.*)$/

tcp_client = TCPSocket.new ip, 443
ssl_client = OpenSSL::SSL::SSLSocket.new tcp_client
ssl_client.connect
cert = OpenSSL::X509::Certificate.new(ssl_client.peer_cert)
ssl_client.sysclose
tcp_client.close

cn = cert.subject.to_s.match(regex_CN)[1]
puts ip + ',' + cn + ',CN'

cert.extensions.to_s.split(',').each do |test|
  if test.match(regex_alt)
    puts ip + ',' + test.match(regex_alt)[1] +',DN'
  end
 end
