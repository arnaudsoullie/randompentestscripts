require 'timeout'
# ------------- Main
debut = Time.now
# ------------- End Main

# ------------- Banner

# ------------- End Banner

# ------------- User input

usage = "\r\nUsage : brute_force_ssh.rb keyfile hosts.txt user\r\n\r\n"
# Incorrect usage of the script
if ARGV.length < 3
	then print usage
	exit
end
file_input = ARGV[1]
key = ARGV[0]
user = ARGV[2]


# Calcul du nombre de lignes
line_count = File.new(file_input, "r")
count = 0
while (line = line_count.gets)
	count = count + 1
end

puts count.to_s + ' IP a tester ...'


# Extracts URLs from file
file = File.new(file_input, "r")
i = 0
while (line = file.gets)
	#sleep(1)
	#puts line.chomp
  command = 'ssh -q -o BatchMode=yes -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i ' + key + ' ' + user + '@' + line.chomp + ' "echo 2>&1" && echo "' + line.chomp + ':' + user + ':OK" || echo "' + line.chomp + ':' + user + ':NOK" '
	#puts command
  puts i.to_s + '/' + count.to_s
	i = i + 1
  begin
		Timeout::timeout(30) { system command }
	rescue Timeout::Error
		puts line.chomp + ':'+ user + ':Timeout'
	end


end
file.close

puts "Over."
